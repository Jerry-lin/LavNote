# 第一章 MySQL架构与历史

## 1.1.MySQL逻辑架构

![image-20180503084147843](/Users/youyujie/Documents/读书笔记/高性能MySQL/图片/MySQL逻辑架构.png)

第一层给予网络的客服端/服务器的工具，连接处理、授权、安全

第二层：核心服务功能，查询解析、分析、优化、缓存，主要是存储过程、触发器、视图。

第三层：存储引擎，负责MySQL数据的存储和提取，支持事务。

### 1.1.1连接管理与安全性

​	每一个客户端连接购回在服务器进程中拥有一个线程，这个线程的查询只会在这个单独的线程中执行。服务器会缓存这些线程，因此不需要为每一个新建的连接创建或者销毁线程。连接基于SSL

### 1.1.2优化与执行

​	MySQL会解析查询，并创建内部数据结构(解析树)，然后对其进行各种有害，包括充血查询、决定表的读取顺序，以及选择合适的索引。

## 1.2并发控制

​	MySQL在两个层面的兵法控制：服务器和存储引擎层。

### 1.2.1读写锁

​	在处理兵法读和写时，可以通过实现一个由两种类型的锁组层的锁系统来解决问题。这两种类型的锁通常是共享锁和排他锁，也叫做读锁和写锁。

​	读锁是共享的，相互不阻塞，写锁是排他的。

### 1.2.2锁粒度	

​	各种MySQL存储引擎都可以实现自己的锁策略和锁粒度。

​	**表锁**

​	MySQL基本策略，锁定整张表。写锁比读锁有更高的优先级。

​	**行级锁**

​	在数据存储层实现。

## 1.3事务

​	事务就是一组原子性的SQL查询，或者说是一个独立的单元。事务内的语句要么全部执行成功，要么全部执行失效。

​	ACID：

​	原子性：事务被视为一个不可分割的最小单元，要么全部成功，要么全部失败回滚。

​	一致性：数据库总是从一个一致性状态转化到另一个一致性状态。

​	隔离性：一个事务所做的修改在最终提交以前，对其他事务是不可见的。

​	持久性：一旦事务提交，则其所做的修改就会永久保存到数据库中。

### 1.3.1隔离级别

​	四种隔离级别

​	未提交读:事务可以读物为提交的数据，也即是脏读。

​	提交读：出现不可重复读问题

​	可重复读：幻读，指的是某个事务在读取某个范围内的记录，另一个事务又在该范围内插入新的记录，当前的事务读取该范围内的记录，会产生幻行。MySQL默认隔离级事务。

​	可窜性读：每一行数据加锁。导致大量的超时和锁争用。

​	![image-20180503091311083](/Users/youyujie/Documents/读书笔记/高性能MySQL/图片/事务级别.png)

### 1.3.2死锁

​	死锁是两个或者多个事务在同一资源是哪个互相占用，请求锁定对方占用的资源，从而导致恶心循环的现象。

​	InnoDB处理死锁的方法是，将持有最少行级排他锁的事务进行回滚。

### 1.3.3事务日志

​	使用事务日志，存储引擎在修改表的数据时只需要修改内存拷贝，再把修改该行的行为记录到持久在硬盘上的事务日志中。事务日志采用追加的方式。

### 1.3.4MySQL中的事务

​	**自动提交**

​	设置自动提交，只有显示遇到commit，才会结束一个事务。

​	**在事务中混合使用存储引擎**

​	事务是由下层的存储引擎实现的。

​	**隐式和显示锁定**

​	InnoDB采用两阶段锁定。

## 1.4多版本并发控制

​	为了提高性能，数据库都提供了多版本并发控制(MVCC)，避免了加锁操作；是通过保存数据在莫讴歌时间点的快找来实现的。

​	MVCC的实现有很多，最典型的有乐观并控制和悲观并发控制。

​	MVCC在可重复读中的实现，在每行记录中保存两个隐藏的实现，一个保存行的创建时间(系统版本号)，一个是过期时间(删除时间)。

​	SELECT语句：

​	1.InnoDB只查找版本早于当前事务版本的数据行

​	2.行的删除版本要么未定义要么大雨当亲啊事务版本号

​	INSERT：

​	InnoDB为新插入的每一行保存当前系统版本号座位行版本号

​	DELETE：

​	InnoDB为删除的每一行保存当前版本号作为行删除标识。

​	UPDATE：

​	InnoDB插入一行新纪录，保存当亲版本号为行版本号和行删除标识。

​	只有不可重复读和可重复读支持MVCC

## 1.5MySQL存储引擎

### 1.5.1InnoDB存储引擎

​	处理大量的短期事务。

​	InnoDB的数据存储在表空间，基于聚簇索引建立，存储格式是平台独立，采用可预测预读，在内存创建hash索引加速读操作的自适应哈希索引。

### 1.5.2MyISAM存储引擎

​	不支持事务和行级锁，存储在在数据文件和索引文件

​	特性：

​	加锁与并发：针对整个表加锁，读取加共享锁，写入加排他锁。

​	修复：手工或者自动执行检查和修复操作，可能导致数据丢失。

​	索引特性：支持全文索引，基于分词叉棍见索引，支持复杂查询。

​	延迟更新索引键：先跟心内存的键缓冲区没然后再将对应索引块写入磁盘。

​	MyISAM压缩表不支持修改，极大的减少空间占有，还有 就是磁盘IO，提高性能。

### 1.5.3其他存储索引

​	

​	