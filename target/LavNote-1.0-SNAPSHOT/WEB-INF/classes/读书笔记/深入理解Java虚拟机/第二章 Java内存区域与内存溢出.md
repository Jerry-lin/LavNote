# 第二章 Java内存区域与内存溢出

## 2.1Java虚拟机运行时数据区域

![image-20180513151109249](/Users/youyujie/Documents/读书笔记/深入理解Java虚拟机/JVM运行时数据区.png)

### 2.1.1程序计数器

当前线程所执行的字节码指示器，线程私有。

### 2.1.2Java虚拟机栈

线程私有，存储局部变量，栈帧，操作数栈，动态链接，方法出口等信息。

### 2.1.3本地方法栈

调用操作系统的类库

### 2.1.4Java堆

线程共享，基本上所有的对象均在Java堆中，垃圾回收的主要区域

### 2.1.5方法区

线程共享，存储类信息、常量、静态变量、及时编译后的代码数据

### 2.1.6运行时常量池

方法区一部分，存储各种字面值和符号引用。

## 2.2虚拟机对象探秘

### 2.2.1对象的创建

创建过程

1.在堆中分配一块内存区域，用于存放对象，

2.初始化对象中的各个数据变量和设置对象头，各个类型默认到值

3.执行init方法，对于各个变量赋予初值

Java堆分配内存空间的方法：

1.指针碰撞：使用的内存和空闲内存用指针隔离开来

2.空闲列表：记录那些位置空闲

为了对象创建的线程，每个线程具有自己的本地线程缓冲区TLAB，当TLAB不够用时，需要再次请求分配TLAB需要同步。

### 2.2.2对象的布局

对象的3个区域：

对象头、实例数据和对齐填充。

![image-20180513152429442](/Users/youyujie/Documents/读书笔记/深入理解Java虚拟机/对象头信息.png)

对象头是8字节的整数倍

实例数据：对象真正存储的有效数据

对齐填充：对象需要是8字节的整数倍

### 2.2.3对象的访问定位

栈中含有对象引用

两种方式

1.句柄访问：堆中划分一部分空间作为句柄池，存储的句柄信息，大多数虚拟机采用

![image-20180513152723060](/Users/youyujie/Documents/读书笔记/深入理解Java虚拟机/句柄访问.png)

2.直接指针：直接对象的地址

![image-20180513152757716](/Users/youyujie/Documents/读书笔记/深入理解Java虚拟机/直接指针.png)

句柄访问：不用改变句柄地址，引用不需要改变

## 2.4内存溢出和内存泄漏

内存溢出：由于内存空间不足，导致的无法分配足够的内存

内存泄漏：分配过的内存无法回收，也无法访问