# 第四章 连接管理

## 4.1TCP连接

### 4.1.1TCP的可靠数据管道

​	TCP为HTTP提供了一条可靠的比特传输管道。

### 4.1.2TCP流逝分段的、由IP分组传送

​	HTTP要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的TCP连接按序传输。

### 4.1.2保持TCP连接的正确运行

​	TCP通过端口号来保持这些连接的正确运行。

## 4.2对TCP性能的考虑

​	HTTP事务的性能很大程度上取决于底层TCP通道的性能。

### 4.2.1HTTP事务的延时

​	HTTP事务延时的主要原因：

​	1.客户端根据URI确定IP地址和端口。这里需要DNS解析

​	2.客户端发送一条TCP连接请求，等待服务器应答。

​	3.一旦连接建立，发送HTTP请求，服务器解析。

​	4.服务器响应

### 4.2.2性能聚焦区域

​	TCP相关延时：

​	TCP建立握手

​	TCP蛮启动拥塞控制

​	数据聚集的Nagle算法

​	TCP延迟确认算法

​	TIME_WAIT时延和端口耗尽

### 4.2.3TCP连接的握手延时

​	1.客户端发送SYN包，请求建立连接

​	2.服务器确认ACK，发送SYN

​	3.客户端发送ACK

### 4.2.4延迟确认

​	TCP实现了确认机制保证数据的成功传输

### 4.2.5慢启动

​	TCP慢启动

### 4.2.6Nagle算法与TCP_NODELAY

​	该算法鼓励发送全尺寸(1500字节)的段，只有其他分组都被确认之后，该算法才允许发送非全尺寸的分组。设置TCP_NODELAY才会禁止该算法。

### 4.2.6TIME_WAIT积累与端口耗尽

​	当某一个TCP端点关闭TCP连接时，会在内存维护一个小的控制块，用来记录最近关闭连接的IP地址和端口，这里星系会维持2分钟，这确保了这段时间内不会创建具有相同地址和端口号的新连接。防止两分钟内叉棍见、关闭病重新创建两个具有相同IP地址和端口号的连接。

​	一台或者多台产生的流量的计算机连接到某个系统中去，这样就限制了连接到无腹鳍的客户端IP地址数，使用TIME_WAIT防止端口号重用，限制了连接的组合。

​	每次连接回去新的源端口，实现唯一连接，源端口数量有限，在120秒内，服务器连接率不超过500次/秒，就不会遇到TIME_WAIT问题。解决方法是增加客户端负载生成机器的数量。

## 4.3HTTP连接的处理

### 4.3.1常被误解的Connection首部

​	Connection首部可以承载3种不同类型的标签：

​	1.HTTP首部字段名，列出只与此链接相关的首部

​	2.任意标签值，用于描述此连接的非标准选项

​	3.值close，说明操作完成之后需关闭这条持久连接

### 4.3.2串行事务处理延时

​	并行连接

​	通过多条TCP连接发起并发的HTTP请求

​	持久连接

​	重用TCP连接，以消除连接以及关闭时延

​	管道化连接

​	通过共享TCP连接发起并发的HTTP请求

​	复用连接

​	交替船体请求和响应报文

## 4.4并行连接

​	HTTP允许客户端打开多条连接，并行执行多个HTTP事务。

### 4.4.1并行连接可能会提高页面的加载速度

​	包含嵌入对象的组合页面如果能克服单条连接的空载时间和带宽限制，加载速度将会有所提高。

### 4.4.2并行连接不一定更快

​	客户端的网络带宽不足，大部分时间可能都是用来传递数据，这种情况下，一个连接在速度较快服务器上的HTTP事务就会很容易非耗尽所有可用的带宽。

### 4.4.3并行连接可能让人感觉更快一些

## 4.5持久连接

​	初始化对某服务器HTTP请求的应用程序很可能会在不久的将来对那台服务器发起更过的请求，这种性质被称为站点本地性。

​	在事务处理结束以后仍然保持在打开状态的TCP连接被称为持久连接。HTTP/1.1支持持久连接。

### 4.5.1持久以及并行连接

​	持久连接有两种类型：比较老的HTTP/1.0+ "keep-alive"连接和现代HTTP/1.1 “persistent”连接

### 4.5.2keep-alive连接

​	![image-20180503161213259](/Users/youyujie/Documents/读书笔记/TCP:IP/HTTP权威指南图片/持久连接的示意图.png)

### 4.5.3Keep-Alive操作

​	实现keep-alive脸的客户端通过包含Connection：Keep-Alive首部请求将一条连接保持打开状态。

### 4.5.4Keep-Alive选项

​	服务器客户端不一定同意keep-alive，需要设置逗号参数管理

​	timeout 连接保持时间

​	参数键max	估计服务器还有多少个事务保持此连接的活跃状态

​	支持未经出来的属性，用于诊断和调试。

### 4.5.5Keep-Alive连接的限制和规则

HTTP/1.0中，keep-alive并不是默认使用的。

Connection:keep-alive首部必须随所有希望保持持久连接的报文一起发送。

客户端探明有没有持久连接首部，直到服务器响应之后是否关闭连接

### 4.5.6keep-alive和哑代理

​	1.Connection首部和盲中继

​	不理解首部，直接转发，没有删除Connection首部，这就是盲中继。

​	2.代理和逐跳首部

​	现在的代理不转发含有Connection的首部

### 4.5.7插入Proxy-Connection

### 4.5.8HTTP/1.1持久连接

​	默认激活，代替Keep-alive连接，除非特别指明，否则HTTP/1.1嘉定所有的连接都是持久的。

### 4.5.9持久连接的限制和规则

## 4.6管道化连接

​	HTTP/1.1允许持久连接使用请求管道。

## 4.7关闭连接的奥秘

### 4.7.1任意解除连接

### 4.7.2正常关闭

​	TCP连接时双向的

​	1.完全关闭与半关闭

​	应用程序可以关闭TCP的输入和输出任意一个，或者两者都关闭。

​	2.TCP关闭以及充值错误

​	使用半关闭来防止对等实体受到非预期的写入错误变得很重要。



​	

​	